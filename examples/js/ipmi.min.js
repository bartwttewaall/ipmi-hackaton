var __decorate=this&&this.__decorate||function(c,e,l,k){var b=arguments.length,a=3>b?e:null===k?k=Object.getOwnPropertyDescriptor(e,l):k,d;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(c,e,l,k);else for(var f=c.length-1;0<=f;f--)if(d=c[f])a=(3>b?d(a):3<b?d(e,l,a):d(e,l))||a;return 3<b&&a&&Object.defineProperty(e,l,a),a},__extends=this&&this.__extends||function(c,e){function l(){this.constructor=c}for(var k in e)e.hasOwnProperty(k)&&(c[k]=e[k]);l.prototype=e.prototype;
c.prototype=new l},IPMI;
(function(c){var e=function(){return function(b,a){void 0===b&&(b=0);void 0===a&&(a=0);this.x=b;this.y=a}}();c.Vec2=e;e=function(b){function a(a,f){void 0===a&&(a=0);void 0===f&&(f=0);b.call(this,a,f)}__extends(a,b);return a}(c.Vec2);c.Point2=e;e=function(){return function(){}}();c.BoundingBox=e;var l=function(){function b(a,d,f,b,c){void 0===b&&(b=!1);void 0===c&&(c=0);this.context=this.listener=this.signal=null;this.isOnce=!1;this.priority=0;this.active=!0;this.signal=a;this.listener=d;this.context=
f;this.isOnce=b;this.priority=c}b.prototype.execute=function(a){var d;this.active&&this.listener&&(d=this.listener.apply(this.context,a),this.isOnce&&this.detach());return d};b.prototype.detach=function(){this.signal.remove(this.listener,this.context)};b.prototype.destroy=function(){this.context=this.listener=this.signal=null};return b}();c.SignalBinding=l;e=function(){function b(a){this.name=null;this.bindings=[];this.name=a}b.prototype.addBinding=function(a){this.bindings.push(a);this.bindings.sort(function(a,
f){return a.priority>f.priority?1:f.priority<a.priority?-1:0})};b.prototype.validateListener=function(a,d){"function"!==typeof a&&(c.Tools.Error("Listener is a required argument of "+d+" and should be a Function."),a=function(){});return a};b.prototype.indexOfListener=function(a,d){for(var f=this.bindings.length,b;f--;)if(b=this.bindings[f],b.listener===a&&b.context===d)return f;return-1};b.prototype.has=function(a,d){void 0===d&&(d=null);return-1!==this.indexOfListener(a,d)};b.prototype.add=function(a,
d,f){void 0===d&&(d=null);void 0===f&&(f=0);a=new l(this,this.validateListener(a,"add"),d,!1,f);this.addBinding(a);return this};b.prototype.addOnce=function(a,d,f){void 0===d&&(d=null);void 0===f&&(f=0);a=new l(this,this.validateListener(a,"add"),d,!0,f);this.addBinding(a);return this};b.prototype.remove=function(a,d){var f=this.indexOfListener(a,d);-1!==f&&(this.bindings[f].destroy(),this.bindings.splice(f,1));return this};b.prototype.removeAll=function(){for(var a=this.bindings.length;a--;)this.bindings[a].destroy();
this.bindings.length=0;return this};b.prototype.dispatch=function(){for(var a=[],d=0;d<arguments.length;d++)a[d-0]=arguments[d];var d=this.bindings.slice(),f=d.length;do f--;while(d[f]&&!1!==d[f].execute(a));return this};b.prototype.dispose=function(){this.removeAll();this.bindings=[]};return b}();c.Signal=e;e=function(){function b(a,d,f,b){void 0===a&&(a="localhost");void 0===d&&(d=7681);void 0===f&&(f="");void 0===b&&(b={autoreconnect:!0});this.connected=!1;this.retries=0;this.ConnectionOpenedSignal=
new c.Signal("ConnectionOpened");this.ConnectionClosedSignal=new c.Signal("ConnectionClosed");this.DisconnectSignal=new c.Signal("Disconnect");this.MessageReceivedSignal=new c.Signal("MessageReceived");this.SendMessageSignal=new c.Signal("SendMessage");c.Tools.LogGroup("Starting WebSocket connection");this.hostaddr=a;this.hostport=d;this.hostpath=f;this.options=b;this.connect();this.DisconnectSignal.add(this.onDisconnect,this);this.SendMessageSignal.add(this.onSendMessage,this);c.Tools.LogGroupEnd()}
b.prototype.connect=function(){this.connection=new WebSocket("ws://"+this.hostaddr+":"+this.hostport.toString()+(this.hostpath||""));this.connection.onmessage=this.onMessageReceived.bind(this);this.connection.onopen=this.onConnectionOpened.bind(this);this.connection.onclose=this.onConnectionClosed.bind(this);c.Tools.Inform("WebSocket initialized")};b.prototype.send=function(a){a=a instanceof Object?JSON.stringify(a):a;this.connection.send(a)};b.prototype.onConnectionOpened=function(a){c.Tools.Inform("WebSocket connection opened");
this.connected=!0;this.retries=0;this.ConnectionOpenedSignal.dispatch()};b.prototype.onConnectionClosed=function(a){var d=this;this.connected?c.Tools.Warn("WebSocket connection lost"):c.Tools.Warn("Unable to establish WebSocket connection");this.connected=!1;this.ConnectionClosedSignal.dispatch();this.options.autoreconnect&&(this.retries++,5<this.retries?(c.Tools.Inform("WebSocket connection configured to autoreconnect, attempting DELAYED reconnect..."),setTimeout(function(){d.connect()},5E3)):(c.Tools.Inform("WebSocket connection configured to autoreconnect, attempting INSTANT reconnect..."),
this.connect()))};b.prototype.onDisconnect=function(){this.connection.close()};b.prototype.onMessageReceived=function(a){switch(this.options.datatype){case "json":a=JSON.parse(a.data);break;default:a=a.data}this.MessageReceivedSignal.dispatch(a)};b.prototype.onSendMessage=function(a){this.send(a)};return b}();c.Socket=e;e=function(){function b(){}Object.defineProperty(b,"DEBUG",{get:function(){return this._DEBUG},set:function(a){(this._DEBUG=a)&&this.Warn("Debug mode enabled, make sure to disable for deployment!",
!0)},enumerable:!0,configurable:!0});Object.defineProperty(b,"prefix",{get:function(){var a=new Date;return"IPMI - ["+[this.LPad(a.getHours(),2,0),this.LPad(a.getMinutes(),2,0),this.LPad(a.getSeconds(),2,0)].join(":")+"."+this.LPad(a.getMilliseconds(),3,0)+"]: "},enumerable:!0,configurable:!0});b.LPad=function(a,d,b){void 0===b&&(b=" ");b=b.toString();a=a.toString();for(var c=0;a.length<d&&200>=++c;)a.length+b.length>d&&(b=b.substr(0,d-a.length)),a=b+a;return a};b.RPad=function(a,d,b){void 0===b&&
(b=" ");b=b.toString();a=a.toString();for(var c=0;a.length<d&&200>=++c;)a.length+b.length>d&&(b=b.substr(0,d-a.length)),a+=b;return a};b.Pad=function(a,d,b){void 0===b&&(b=" ");b=b.toString();a=a.toString();for(var c=!1,e=0;a.length<d&&200>=++e;)a.length+b.length>d&&(b=b.substr(0,d-a.length)),a=!0===c?b+a:a+b,c=!c;return a};b.Rad2Deg=function(a){return 180*a/Math.PI};b.Deg2Rad=function(a){return a/180*Math.PI};b.Invert=function(a){if("number"==typeof a)return-a;if("string"==typeof a)return a;if("boolean"==
typeof a)return!a;if("object"==typeof a){if(a instanceof Array)for(var d=0;d<a.length;d++)a[d]=b.Invert(a[d]);else for(d in a)a[d]=b.Invert(a[d]);return a}};b.getClassName=function(a){return/function (.{1,})\(/.exec(a.constructor.toString())[1]};b.LogGroup=function(a){this.DEBUG&&console.groupCollapsed.apply(console,["%c"+this.prefix+a,"color: green; font-weight: bold;"])};b.LogGroupEnd=function(){this.DEBUG&&console.groupEnd()};b.Debug=function(a){this.DEBUG&&console.log("%c"+this.prefix+a,"color: purple; font-weight: bold")};
b.Inform=function(a){this.DEBUG&&console.log("%c"+this.prefix+a,"color: #333; font-weight: bold")};b.Log=function(a,d){(this.DEBUG||d)&&console.log("%c"+this.prefix+a,"color: #333; font-weight: bold")};b.Notify=function(a){this.DEBUG&&console.log("%c"+this.prefix+a,"color: blue; font-weight: bold")};b.Warn=function(a,d){(this.DEBUG||d)&&console.log("%c"+this.prefix+a,"color: orange; font-weight: bold")};b.Error=function(a){a instanceof TypeError?console.log("%c"+this.prefix+a.stack.replace("\n","\n%c"),
"color: red; font-weight: bold","color: black; font-weight: normal"):console.log("%c"+this.prefix+a,"color: red; font-weight: bold")};b._DEBUG=!1;return b}();c.Tools=e;e.DEBUG=!1;e=function(){function b(){}b.prototype.map=function(a){for(var d in a)this.hasOwnProperty("_"+d)?this["_"+d]=a[d]:this[d]=a[d]};return b}();c.JSONMapper=e;e=function(){function b(){this.firstRegistration=(new Date).getTime()}Object.defineProperty(b.prototype,"base",{get:function(){return{x:this.boundingbox.x+this.boundingbox.width/
2,y:this.boundingbox.y+this.boundingbox.height}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"top",{get:function(){return{x:this.boundingbox.x+this.boundingbox.width/2,y:this.boundingbox.y}},enumerable:!0,configurable:!0});return b}();c.Blob=e;e=function(){function b(a,d){this.config=a;this.root=d}b.prototype.start=function(){c.Tools.Warn(c.Tools.getClassName(this)+" does not implement the start() method")};b.prototype.getBlobs=function(){c.Tools.Warn(c.Tools.getClassName(this)+
" does not implement the getBlobs() method");return[]};return b}();c.BaseAdapter=e;e=function(b){function a(a,c){b.call(this,a,c)}__extends(a,b);return a}(c.BaseAdapter);c.MouseAdapter=e;e=function(b){function a(a,c){b.call(this,a,c)}__extends(a,b);return a}(c.BaseAdapter);c.SimulationAdapter=e;e=function(b){function a(a,c){b.call(this,a,c);this.connected=!1;this.blobs=[];this.maxAge=1E4;this.removeDelay=2E4;this.start();this.root.DisconnectSignal.add(this.onDisconnect,this);this.root.SendMessageSignal.add(this.onSendMessage,
this)}__extends(a,b);a.prototype.start=function(){c.Tools.LogGroup("Starting TSPS adapter");this.socket=new c.Socket(this.config.hostaddr,this.config.hostport,this.config.hostpath,{autoreconnect:!0,protocol:"tsps-protocol",datatype:"json"});this.socket.ConnectionOpenedSignal.add(this.onConnected,this,1);this.socket.ConnectionClosedSignal.add(this.onDisconnected,this,1);this.socket.MessageReceivedSignal.add(this.onMessage,this,1);c.Tools.LogGroupEnd()};a.prototype.createBlob=function(a){var b=new c.Blob;
this.reassignProperties(b,a);return this.blobs[b.id]=b};a.prototype.updateBlob=function(a){var b=this.blobs[a.id]||this.createBlob(a);b.age>a.age?console.log("Wrong order message for blob",b.id,"(most recent age:",b.age,"received age:",a.age,")"):(this.reassignProperties(b,a),b.removed&&(b.removed=!1,b.firstRegistration=(new Date).getTime()));return b};a.prototype.removeBlob=function(a){var b=this.blobs[a.id]||this.createBlob(a);this.reassignProperties(b,a);this.blobs[b.id].removed=!0;return b};a.prototype.sanitizeBlobs=
function(){var a=new Date,b=!1,c;for(c in this.blobs)a.getTime()-this.blobs[c].firstRegistration>this.removeDelay?delete this.blobs[c]:a.getTime()-this.blobs[c].firstRegistration>this.maxAge&&!this.blobs[c].removed&&(b=this.blobs[c].removed=!0);b&&this.root.PersonChangedSignal.dispatch()};a.prototype.getBlobs=function(){var a=[],b;for(b in this.blobs)this.blobs[b].removed||a.push(this.blobs[b]);return a};a.prototype.reassignProperties=function(a,b){a.id||(a.id=b.id);a.age=b.age;a.boundingbox=b.boundingrect;
a.contours=b.contours;a.centroid=b.centroid;a.velocity=b.velocity};a.prototype.onConnected=function(){c.Tools.Notify("Connected to TSPS host");this.connected=!0;this.blobs.length=0;this.root.ConnectionOpenedSignal.dispatch()};a.prototype.onDisconnected=function(){this.connected?c.Tools.Error("Connection to TSPS host lost"):c.Tools.Error("Unable to establish a connection to TSPS host");this.connected=!1;this.root.ConnectionClosedSignal.dispatch()};a.prototype.onDisconnect=function(){this.socket.DisconnectSignal.dispatch()};
a.prototype.onMessage=function(a){this.root.DataReceivedSignal.dispatch(a);this.sanitizeBlobs();switch(a.type){case "backgroundCaptured":this.onBackgroundCaptured(a);break;case "imageRequested":this.onImageRequested(a);break;case "scene":this.onSceneUpdated(a);break;case "personEntered":a=this.createBlob(a);this.onPersonEntered(a);break;case "personWillLeave":a=this.removeBlob(a);this.onPersonLeft(a);break;case "personMoved":a=this.updateBlob(a);this.onPersonMoved(a);break;case "personUpdated":a=
this.updateBlob(a);this.onPersonUpdated(a);break;default:this.onUnspecifiedEvent(a)}};a.prototype.onBackgroundCaptured=function(a){c.Tools.Inform("TSPS background recaptured, captureId: "+a.id)};a.prototype.onImageRequested=function(a){this.root.ImageCapturedSignal.dispatch(a)};a.prototype.onSceneUpdated=function(a){this.root.SceneUpdatedSignal.dispatch(a)};a.prototype.onPersonEntered=function(a){this.root.PersonEnteredSignal.dispatch(a);this.root.PersonChangedSignal.dispatch()};a.prototype.onPersonLeft=
function(a){this.root.PersonLeftSignal.dispatch(a);this.root.PersonChangedSignal.dispatch()};a.prototype.onPersonUpdated=function(a){this.root.PersonUpdatedSignal.dispatch(a);this.root.PersonChangedSignal.dispatch()};a.prototype.onPersonMoved=function(a){this.root.PersonMovedSignal.dispatch(a);this.root.PersonChangedSignal.dispatch()};a.prototype.onSendMessage=function(a){this.socket.SendMessageSignal.dispatch(a)};a.prototype.onUnspecifiedEvent=function(a){this.root.UnspecifiedEventSignal.dispatch(a)};
return a}(c.BaseAdapter);c.TSPSAdapter=e;e=function(b){function a(a,c){b.call(this,a,c);this.lastSimTime=this.currentSimFrame=this.simFrames=0}__extends(a,b);a.prototype.start=function(){var a=this;c.Tools.Log("Bypassed TSPS connection setup");this.loadSimFile(this.config).then(function(b){a.simData=b;a.startSimulation()})};a.prototype.loadSimFile=function(a){return new Promise(function(b,e){var g=new XMLHttpRequest;g.open("GET",a.simfile);g.onload=function(){200===g.status?(c.Tools.Log("Loaded simulation file: "+
a.simfile),b(JSON.parse(g.responseText))):e(c.Tools.Error("Cannot load simulation file: "+a.simfile))};g.onerror=function(){e(c.Tools.Error("Cannot load simulation file: "+a.simfile))};g.send()})};a.prototype.startSimulation=function(){this.runFrame()};a.prototype.runFrame=function(){var a=this,b=this.simData[this.currentSimFrame++];b||(this.currentSimFrame=0,b=this.simData[this.currentSimFrame++]);var c=this.lastSimTime=b.__time__,e=this.simData[this.currentSimFrame],h=500;e&&(h=e.__time__-c);this.onMessage(b);
setTimeout(function(){return a.runFrame()},h)};return a}(c.TSPSAdapter);c.TSPSSimulationAdapter=e;(function(b){b[b.TSPS=1]="TSPS";b[b.TSPSSimulator=2]="TSPSSimulator";b[b.Mouse=3]="Mouse";b[b.Touch=4]="Touch";b[b.Simulator=5]="Simulator"})(c.TrackingMethod||(c.TrackingMethod={}));var k=c.TrackingMethod,e=function(){function b(a){this.ConnectionOpenedSignal=new c.Signal("ConnectionOpened");this.ConnectionClosedSignal=new c.Signal("ConnectionClosed");this.SendMessageSignal=new c.Signal("SendMessage");
this.DisconnectSignal=new c.Signal("Disconnect");this.DataReceivedSignal=new c.Signal("DataReceived");this.UnspecifiedEventSignal=new c.Signal("UnspecifiedEvent");this.SceneUpdatedSignal=new c.Signal("SceneUpdated");this.PersonEnteredSignal=new c.Signal("PersonEntered");this.PersonLeftSignal=new c.Signal("PersonLeft");this.PersonUpdatedSignal=new c.Signal("PersonUpdated");this.PersonMovedSignal=new c.Signal("PersonMoved");this.PersonChangedSignal=new c.Signal("PersonChanged");this.ImageCapturedSignal=
new c.Signal("ImageCaptured");c.Tools.LogGroup("Start tracking module");this.config=a;this.loadAdapter(a);c.Tools.LogGroupEnd()}b.prototype.loadAdapter=function(a){switch(a.method){case k.TSPS:c.Tools.Inform("Load tracking adapter for TSPS");this.adapter=new c.TSPSAdapter(a,this);break;case k.TSPSSimulator:c.Tools.Inform("Load tracking adapter for TSPS");this.adapter=new c.TSPSSimulationAdapter(a,this);break;case k.Mouse:case k.Touch:c.Tools.Inform("Load tracking adapter for Mouse/Touch");this.adapter=
new c.MouseAdapter(a,this);break;case k.Simulator:c.Tools.Inform("Load tracking adapter for Simulator");this.adapter=new c.SimulationAdapter(a,this);break;default:c.Tools.Error("Invalid adapter type specified")}};b.prototype.getBlobs=function(){return this.adapter.getBlobs()};return b}();c.Tracking=e;e=function(){function b(a,b,e,k,g){void 0===e&&(e=!0);void 0===k&&(k=!0);void 0===g&&(g=!1);this.reduceCameraRequests=1;this.cameraRequestSequence=0;this.tracking=a;this.canvas=b;this.shouldAutoUpdate=
e;this.shouldCaptureBackground=k;this.shouldUseCamera=g;this.context=this.canvas.getContext("2d");this.canvas.width=this.canvas.offsetWidth;this.canvas.height=this.canvas.offsetWidth;this.backgroundCanvas=document.createElement("canvas");this.backgroundContext=this.backgroundCanvas.getContext("2d");this.cameraCanvas=document.createElement("canvas");this.cameraContext=this.cameraCanvas.getContext("2d");this.differenceCanvas=document.createElement("canvas");this.differenceContext=this.differenceCanvas.getContext("2d");
k&&this.tracking.ConnectionOpenedSignal.add(this.captureBackground,this);g&&c.Tools.DEBUG&&(this.tracking.PersonChangedSignal.add(this.captureCamera,this),c.Tools.Warn("TrackingVisualizer, using camera capture severely impacts tracking performance, do not use by default!"));(k||g)&&this.tracking.ImageCapturedSignal.add(this.imageCaptured,this);e&&this.tracking.SceneUpdatedSignal.add(this.autoUpdate,this)}b.prototype.autoUpdate=function(){var a=this.tracking.getBlobs();this.update(a)};b.prototype.update=
function(a){this.canvas.width=this.canvas.offsetWidth;this.canvas.height=this.canvas.offsetWidth;this.shouldCaptureBackground&&this.context.drawImage(this.backgroundCanvas,0,0,this.canvas.width,this.canvas.height);this.shouldUseCamera&&this.context.drawImage(this.cameraCanvas,0,0,this.canvas.width,this.canvas.height);this.context.drawImage(this.differenceCanvas,0,0,this.canvas.width,this.canvas.height);for(var b in a)this.draw(a[b])};b.prototype.captureBackground=function(){this.tracking.SendMessageSignal.dispatch({request:"background"})};
b.prototype.captureCamera=function(){this.cameraRequestSequence++;0==this.cameraRequestSequence%this.reduceCameraRequests&&this.tracking.SendMessageSignal.dispatch({request:"area"})};b.prototype.imageCaptured=function(a){var b,c;switch(a.imageType){case "background":b=this.backgroundCanvas;c=this.backgroundContext;break;case "area":b=this.cameraCanvas;c=this.cameraContext;break;case "difference":b=this.differenceCanvas;c=this.differenceContext;break;default:return}var e=a.width,g=a.height;b.width=
e;b.height=g;b=a.data;e=c.createImageData(e,g);g=e.data;a=this.shouldCaptureBackground?a.imageType:"background";for(var h=0;h<g.length;h+=4)switch(a){case "background":g[h]=b[h/4];g[h+1]=b[h/4];g[h+2]=b[h/4];g[h+3]=255;break;case "area":g[h]=0;g[h+1]=b[h/4];g[h+2]=0;g[h+3]=127;break;case "difference":g[h]=255,g[h+1]=165,g[h+2]=0,g[h+3]=b[h/4]/2}c.putImageData(e,0,0);this.update()};b.prototype.draw=function(a){this.drawContours(a);this.drawBoundingBox(a);this.drawInformation(a);this.drawPoints(a)};
b.prototype.toAbsoluteX=function(a){return a*this.canvas.width};b.prototype.toAbsoluteY=function(a){return a*this.canvas.height};b.prototype.drawContours=function(a){if(a.contours.length){this.context.beginPath();this.context.moveTo(this.toAbsoluteX(a.contours[0].x),this.toAbsoluteY(a.contours[0].y));for(var b=1;b<a.contours.length;b++)this.context.lineTo(this.toAbsoluteX(a.contours[b].x),this.toAbsoluteY(a.contours[b].y));this.context.fillStyle="rgba(255, 0, 0, 0.5)";this.context.fill();this.context.strokeStyle=
"#D00";this.context.stroke();this.context.closePath()}};b.prototype.drawBoundingBox=function(a){this.context.beginPath();this.context.strokeStyle="#00D";this.context.strokeRect(this.toAbsoluteX(a.boundingbox.x),this.toAbsoluteY(a.boundingbox.y),this.toAbsoluteX(a.boundingbox.width),this.toAbsoluteY(a.boundingbox.height));this.context.closePath()};b.prototype.drawInformation=function(a){this.context.beginPath();this.context.font="bold 24px monospace";this.context.fillStyle="#000";this.context.fillText("#"+
a.id,this.toAbsoluteX(a.centroid.x)+10,this.toAbsoluteY(a.centroid.y)+24);this.context.strokeStyle="#000";this.context.strokeText("#"+a.id,this.toAbsoluteX(a.centroid.x)+10,this.toAbsoluteY(a.centroid.y)+24);this.context.closePath()};b.prototype.drawPoints=function(a){this.context.beginPath();this.context.arc(this.toAbsoluteX(a.centroid.x),this.toAbsoluteY(a.centroid.y),5,0,2*Math.PI);this.context.fillStyle="#0D0";this.context.fill();this.context.closePath();this.context.beginPath();this.context.arc(this.toAbsoluteX(a.top.x),
this.toAbsoluteY(a.top.y),5,0,2*Math.PI);this.context.fillStyle="#DD0";this.context.fill();this.context.closePath();this.context.beginPath();this.context.arc(this.toAbsoluteX(a.base.x),this.toAbsoluteY(a.base.y),5,0,2*Math.PI);this.context.fillStyle="#0DD";this.context.fill();this.context.closePath()};return b}();c.TrackingVisualizer=e;e=function(){function b(a){c.Tools.LogGroup("Start IPMI framework");this.config=a;this.setupTracking();c.Tools.LogGroupEnd()}b.prototype.setupTracking=function(){this.Tracking=
new c.Tracking(this.config.tracking)};return b}();c.Framework=e})(IPMI||(IPMI={}));("undefined"!=typeof window&&window.module||"undefined"!=typeof module)&&"undefined"!=typeof module.exports&&(module.exports=IPMI);
